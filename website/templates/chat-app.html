<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@forevolve/bootstrap-dark@1.0.0/dist/css/bootstrap-dark.min.css"/>
	<link rel="stylesheet" href="{{ url_for('static', filename='chat-style.css') }}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="bootstrap-dark">
	<main class="content">
		<div class="container p-0">
			<div class="card">
				<div class="py-2 px-4 border-bottom d-lg-block">
					<div class="d-flex align-items-center py-1">
						<div class="position-relative">
							<polkadot-web-identicon style="display: inline-block;" address="{{ group.room }}" theme="jdenticon" class="rounded-circle mr-1 position-relative" size="48"></polkadot-web-identicon>
						</div>
						<div class="flex-grow-1 pl-3" style="text-align: center;">
							<h4><strong>{{ group.name }}</strong></h4>
							<div class="text-muted small"><em>MCE 21</em></div>
						</div>

						<div>
							<button id="logout" class="btn btn-dark border btn-lg px-3"><i class="glyphicon glyphicon-log-out"></i></button>
						</div>
					</div>
				</div>
				
				<div class="position-relative">
					<div id='chat' class="chat-messages p-4">

					</div>
				</div>
				<div class="flex-grow-0 py-3 px-4 border-top">
					<div class="input-group ">
						<input type="text" class="form-control" id="message_holder" placeholder="Type your message">
						<button class="btn btn-primary" id="send_message">Send <i class="fa fa-send" aria-hidden="true"></i></button>
					</div>
				</div>
			</div>
		</div>
	</main>
	<script type="text/javascript" src="{{ url_for('static', filename='polkadot-web-identicon/main.js') }}"></script>    
    <script type="text/javascript" src="{{ url_for('static', filename='polkadot-web-identicon/polyfills.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='polkadot-web-identicon/runtime.js') }}"></script>
	<script>
	    var socket;
		var current_user = '{{ current_user_id }}';
		function msg_text(msg, sent, sender, c){
			return `<div class="chat-message-${sent} pb-4">
								<div>
									<polkadot-web-identicon style="display: inline-block;" address="${msg.i}" theme="jdenticon" class="rounded-circle mr-1" size="32"></polkadot-web-identicon>
									<div class="text-muted small text-nowrap mt-2">${msg.time}</div>
								</div>
								<div class="flex-shrink-1 bg-dark rounded py-2 px-3 m${c}-3">
									<div class="font-weight-bold mb-1"><h5${sender}</h5></div>
									${msg.msg}
								</div>
							</div>`
		}
        $(document).ready(function(){
            socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
            socket.on('connect', function() {
                socket.emit('online');
            });
			socket.on("general_messages", function(msg){
				$('#chat').append(
					`<div class="chat-message pb-4">
						<div class="flex-shrink-1 bg-dark rounded py-2 px-3">
							${msg}
						</div>
					</div>`);
			});
			socket.on('get_messages', function(msgs) {
				msgs.messages.forEach(function (msg, index) {
					var sent = msg.is_sender ? "right" : "left";
					var c = msg.is_sender ? "r" : "l";
					var sender = msg.is_sender ? " align='right'> You" : ">"+msg.sender
					$("#chat").prepend(
							msg_text(msg, sent, sender, c));
				});
				$('#chat').children().slice(-1)[0].scrollIntoView();
            });
            socket.on('new_message', function(msg) {
				var sent = msg.current_user == current_user ? "right" : "left";
				var c = msg.current_user == current_user ? "r" : "l";
				var sender = msg.current_user == current_user ? " align='right'> You" : ">"+msg.sender
				$("#chat").append(msg_text(msg, sent, sender, c));
				$('#chat').children().pop().scrollIntoView();
				});
            $('#send_message').click(function(e) {
                    text = $('#message_holder').val();
					if (text.replace(' ', "") != ""){
						$('#message_holder').val('');
						$('#message_holder').focus();
						socket.emit('send', {message: text});
					}
            });
			$('#logout').click(function(e){
				var yes = confirm("You will be logged out")
				if (yes) {
					fetch('/logout', {
						method: "GET",
					}).then((_res) => {
						window.location.href = '/login'
					});}
			});
        });
	</script>
</body>
</html>
